title: Create an AWS IAM User
ref: create-an-aws-iam-user
content: |
  Create a new programmatic IAM user in the AWS management console.
  CSFLE-enabled clients authenticate with AWS KMS using the IAM user to
  encrypt and decrypt the remote master key. The IAM user must be granted
  full ``List`` and ``Read`` permissions for the KMS service.

  .. note:: Client IAM User Credentials

     The CSFLE-enabled client uses the IAM User's :guilabel:`Access Key
     ID` and :guilabel:`Secret Access Key` as configuration values. Take
     note of these and reference them when we update the client.
---
title: Create the Master Key
ref: create-the-master-key
content: |

  The following diagram shows how the **master key** is created and stored
  when using a KMS provider:

  .. image:: /figures/CSFLE_Master_Key_KMS.png
     :alt: Diagram that describes creating a master key when using a KMS provider

  In AWS management console, create a new symmetric master key in the KMS
  section. Choose a name and description that helps you identify it; these
  fields do not affect the functionality or configuration.

  In the :guilabel:`Usage Permissions` step of the key generation
  process, add the full KMS ``List`` and ``Read`` permissions to the IAM
  user you created in the previous step. This authorizes the user to encrypt
  and decrypt the new master key.

  .. important::

     The new client IAM User *should not* have administrative permissions
     for the master key.
---
title: Specify the AWS KMS Provider Credentials
ref: specify-the-aws-kms-provider-credentials
content: |
  Unlike the local key provider, the AWS KMS provider does not read
  the master key directly from the client application. Instead,
  it accepts the :guilabel:`Access Key ID` and :guilabel:`Secret Access
  Key` configurations that point to the master key. The IAM user must have
  the permissions set up in the previous step in order for the client to
  use the KMS to encrypt and decrypt data encryption keys.

  Update the KMS Provider configuration in your CSFLE-enabled client
  creation code:

  .. tabs-drivers::

     .. tab::
        :tabid: java-sync

        .. code-block:: java

           // TODO: check correctness
           Map<String, Map<String, Object>> kmsProviders = new HashMap<String, Map<String, Object>>();
           Map<String, Object> providerDetails = new HashMap<String, Object>();

           providerDetails.put("email", new BsonString("<>"));
           providerDetails.put("privateKey", new BsonString("<>"));

           kmsProviders.put("gcp", providerDetails);
     .. tab::
        :tabid: nodejs

        .. code-block:: javascript

           // TODO: check correctness
           kmsProviders = {
             gcp: {
               email: '<>',
               privateKey: '<>',
             }
           }
     .. tab::
        :tabid: python

        .. code-block:: python

           kms_provider = {
               "gcp": {
                   "email": "<>",
                   "privateKey": "<>"
               }
           }
---
title: Create a New Data Encryption Key
ref: create-a-new-data-key
content: |
  The following diagram shows how the **customer master key** is created and
  stored when using a KMS provider:

  .. image:: /figures/CSFLE_Data_Key_KMS.png
     :alt: Diagram that describes creating a data encryption key when using a KMS provider

  You must generate a new **data encryption key** using the **master key**
  in the remote KMS. The original data encryption key was encrypted by
  your locally-managed master key.

  Specify the AWS region and `Amazon Resource Number
  <https://docs.aws.amazon.com/kms/latest/developerguide/viewing-keys.html#find-cmk-id-arn>`_
  (ARN) of the new CMK in the CSFLE-enabled client settings. Use the client
  to create a new data encryption key as follows:

  Once you have the required information, run the following code to
  generate the new data encryption key:

  .. tabs-drivers::

     .. tab::
        :tabid: java-sync

        .. code-block:: Java

           // TODO: check correctness
           DataKeyOptions dataKeyOptions = new DataKeyOptions().masterKey(
               new BsonDocument()
                   .append("provider", "gcp")
                   .append("projectId", "<>")
                   .append("location", "<>")
                   .append("keyRing", "<>")
                   .append("keyName", "<>"));

           BsonBinary dataKeyId = clientEncryption.createDataKey("gcp", dataKeyOptions);
     .. tab::
        :tabid: nodejs

        .. code-block:: javascript

           // TODO: check correctness
           const key = await encryption.createDataKey('gcp', {
              masterKey: {
                provider: 'gcp',
                projectId: '<>',
                location: '<>',
                keyRing: '<>',
                keyName: '<>'
              }
           });

           const base64DataKeyId = key.toString('base64');
           console.log('DataKeyId [base64]: ', base64DataKeyId);
     .. tab::
        :tabid: python

        .. code-block:: python

           master_key = {
               "provider": "gcp",
               "projectId": "<>",
               "location": "<>",
               "keyRing": "<>",
               "keyName": "<>"
           }

---
title: Update the Automatic Encryption JSON Schema
ref: update-the-json-schema
content: |
  If you embedded the key id of your data encryption key in your
  automatic encryption rules, you will need to update the :ref:`JSON
  Schema <fle-define-a-json-schema>` with the new data encryption key id.
